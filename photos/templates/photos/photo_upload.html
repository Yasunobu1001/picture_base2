{% extends 'base.html' %}

{% block title %}写真をアップロード - 写真共有サイト{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-900">写真をアップロード</h1>
            <p class="mt-1 text-sm text-gray-600">
                画像ファイルを自動圧縮してアップロードします（最大1920x1920px、品質85%）
            </p>
        </div>

        <form method="post" enctype="multipart/form-data" class="p-6" id="upload-form">
            {% csrf_token %}
            
            <!-- ドラッグ&ドロップエリア -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ form.image.label }}
                    <span class="text-red-500">*</span>
                </label>
                
                <div id="drop-zone" class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors duration-200 cursor-pointer">
                    <div id="drop-zone-content">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="mt-4">
                            <p class="text-lg text-gray-600">
                                ファイルをドラッグ&ドロップ
                            </p>
                            <p class="text-sm text-gray-500 mt-1">
                                または
                                <button type="button" id="file-select-btn" class="text-blue-600 hover:text-blue-500 font-medium">
                                    ファイルを選択
                                </button>
                            </p>
                        </div>
                    </div>
                    
                    <!-- プレビューエリア -->
                    <div id="preview-area" class="hidden">
                        <img id="preview-image" class="mx-auto max-h-48 rounded-lg shadow-sm" alt="プレビュー">
                        <div class="mt-4">
                            <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                            <p id="file-size" class="text-xs text-gray-500"></p>
                            <button type="button" id="remove-file" class="mt-2 text-sm text-red-600 hover:text-red-500">
                                ファイルを削除
                            </button>
                        </div>
                    </div>
                    
                    <!-- プログレスバー -->
                    <div id="progress-bar" class="hidden mt-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progress-fill" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">アップロード中...</p>
                    </div>
                </div>
                
                {{ form.image }}
                
                {% if form.image.errors %}
                    <div class="mt-2">
                        {% for error in form.image.errors %}
                            <p class="text-sm text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <p class="mt-2 text-xs text-gray-500">
                    {{ form.image.help_text }}
                </p>
            </div>

            <!-- タイトル入力 -->
            <div class="mb-6">
                <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    {{ form.title.label }}
                    <span class="text-red-500">*</span>
                </label>
                {{ form.title }}
                {% if form.title.errors %}
                    <div class="mt-2">
                        {% for error in form.title.errors %}
                            <p class="text-sm text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">
                    {{ form.title.help_text }}
                </p>
            </div>

            <!-- 説明入力 -->
            <div class="mb-6">
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    {{ form.description.label }}
                </label>
                {{ form.description }}
                {% if form.description.errors %}
                    <div class="mt-2">
                        {% for error in form.description.errors %}
                            <p class="text-sm text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">
                    {{ form.description.help_text }}
                </p>
            </div>

            <!-- 公開設定 -->
            <div class="mb-6">
                <div class="flex items-center">
                    {{ form.is_public }}
                    <label for="{{ form.is_public.id_for_label }}" class="ml-2 text-sm text-gray-700">
                        {{ form.is_public.label }}
                    </label>
                </div>
                {% if form.is_public.errors %}
                    <div class="mt-2">
                        {% for error in form.is_public.errors %}
                            <p class="text-sm text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">
                    {{ form.is_public.help_text }}
                </p>
            </div>

            <!-- 送信ボタン -->
            <div class="flex justify-end space-x-3">
                <a href="/" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    キャンセル
                </a>
                <button type="submit" id="submit-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="submit-spinner" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="submit-text">アップロード</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('photo-upload-input');
    const fileSelectBtn = document.getElementById('file-select-btn');
    const dropZoneContent = document.getElementById('drop-zone-content');
    const previewArea = document.getElementById('preview-area');
    const previewImage = document.getElementById('preview-image');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const submitBtn = document.getElementById('submit-btn');
    const submitSpinner = document.getElementById('submit-spinner');
    const submitText = document.getElementById('submit-text');
    const form = document.getElementById('upload-form');

    // ファイル選択ボタンのクリック
    fileSelectBtn.addEventListener('click', function() {
        fileInput.click();
    });

    // ドロップゾーンのクリック
    dropZone.addEventListener('click', function(e) {
        if (e.target === dropZone || e.target === dropZoneContent) {
            fileInput.click();
        }
    });

    // ドラッグ&ドロップイベント
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-blue-400', 'bg-blue-50');
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // ファイル選択イベント
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // ファイル削除ボタン
    removeFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        showDropZone();
    });

    // フォーム送信
    form.addEventListener('submit', function(e) {
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('写真ファイルを選択してください。');
            return;
        }

        // 送信ボタンを無効化
        submitBtn.disabled = true;
        submitSpinner.classList.remove('hidden');
        submitText.textContent = 'アップロード中...';
        
        // プログレスバーを表示
        showProgressBar();
        simulateProgress();
    });

    async function handleFileSelect(file) {
        // ファイル形式チェック
        if (!file.type.startsWith('image/')) {
            alert('画像ファイルのみアップロード可能です。');
            return;
        }

        // 元のファイルサイズを表示
        console.log('元のファイルサイズ:', formatFileSize(file.size));

        // 画像を圧縮
        try {
            const compressedFile = await compressImage(file);
            console.log('圧縮後のファイルサイズ:', formatFileSize(compressedFile.size));
            
            // ファイルサイズチェック（10MB）
            const maxSize = 10 * 1024 * 1024;
            if (compressedFile.size > maxSize) {
                alert('ファイルサイズが大きすぎます。10MB以下のファイルをアップロードしてください。');
                return;
            }

            // ファイル情報を設定
            const dt = new DataTransfer();
            dt.items.add(compressedFile);
            fileInput.files = dt.files;

            // プレビューを表示
            showPreview(compressedFile);
        } catch (error) {
            console.warn('画像圧縮に失敗しました。元ファイルをそのままアップロードします。', error);
            // HEICなどブラウザでデコードできない場合は元ファイルで継続
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            showPreview(file);
        }
    }

    async function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // キャンバスを作成
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 最大サイズを設定（スマホ写真対応）
                    const MAX_WIDTH = 1920;
                    const MAX_HEIGHT = 1920;
                    let width = img.width;
                    let height = img.height;

                    // アスペクト比を維持してリサイズ
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = Math.round((height * MAX_WIDTH) / width);
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = Math.round((width * MAX_HEIGHT) / height);
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // 画像を描画
                    ctx.drawImage(img, 0, 0, width, height);

                    // 圧縮してBlobに変換
                    canvas.toBlob(
                        function(blob) {
                            if (blob) {
                                // 拡張子を.jpgに付け替え
                                const newName = (function(name){
                                    const idx = name.lastIndexOf('.');
                                    if (idx === -1) return name + '.jpg';
                                    return name.substring(0, idx) + '.jpg';
                                })(file.name);
                                const compressedFile = new File([blob], newName, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                reject(new Error('画像の圧縮に失敗しました'));
                            }
                        },
                        'image/jpeg',
                        0.85 // 品質: 85%（高品質を維持しつつ圧縮）
                    );
                };
                img.onerror = function() {
                    reject(new Error('画像の読み込みに失敗しました'));
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                reject(new Error('ファイルの読み込みに失敗しました'));
            };
            reader.readAsDataURL(file);
        });
    }

    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            dropZoneContent.classList.add('hidden');
            previewArea.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function showDropZone() {
        dropZoneContent.classList.remove('hidden');
        previewArea.classList.add('hidden');
        progressBar.classList.add('hidden');
    }

    function showProgressBar() {
        previewArea.classList.add('hidden');
        progressBar.classList.remove('hidden');
    }

    function simulateProgress() {
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.random() * 15;
            if (progress > 90) {
                progress = 90;
            }
            progressFill.style.width = progress + '%';
            
            if (progress >= 90) {
                clearInterval(interval);
            }
        }, 200);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}